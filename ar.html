<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Roman Preparation AR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- MindAR Library -->
  <script src="./libs/mindar/mindar-image-three.prod.js"></script>

  <style>
    html, body {
	background-image: url("assets/images/start.png");
	background-size: 100%;
      margin: 0; padding: 0; overflow: hidden;
      height: 100%; width: 100%;
      font-family: Arial, sans-serif;
    }

    .mindar-container {
      width: 100vw; height: 100vh;
      position: absolute; top: 0; left: 0;
      display: block;
    }

    #ar-ui { width: 100%; height: 100%; }

    #ui-buttons {
      position: absolute; top: 10px; left: 50%;
      transform: translateX(-50%);
      z-index: 10; pointer-events: auto;
    }

    #ui-buttons button {
      padding: 15px 30px; font-size: 18px; margin: 10px;
      background: #33691e; color: white;
      border: none; border-radius: 10px; cursor: pointer;
    }

    #dialogue{
      color: black;
	  font-weight: bold;
      position: absolute; top: 600px; left: 35%;
      padding: 5px;
      width: 400px;
      height: 150px;
    }
    #dialogue-button {
      cursor: pointer;
      position: relative; bottom:-75px;
    }
  </style>
</head>

<body>

  <div id="ui-buttons">
    <button id="start-ar-engine-button">Play</button>
    <button id="return-button">Quit</button>
    <button id="dialogue-button">Next Info</button>
  </div>

  <div id="dialogue">
    <p>This is the text test</p>
  </div>

  <div id="ar-ui" class="mindar-container"></div>

  <script type="module">
    import { loadGLTF, loadAudio } from "./libs/loader.js";
    const THREE = window.MINDAR.IMAGE.THREE;

    let mindarThree = null;
    let isStarted = false;

    const startAREngineButton = document.getElementById("start-ar-engine-button");
    const returnButton = document.getElementById("return-button");
    const arUI = document.getElementById("ar-ui");

    // --- FIX: get 'from' from query string ---
    const params = new URLSearchParams(window.location.search);
    const from = params.get('from') || 'lore'; // fallback to 'lore' if not set

    // Return to the previous page
    const goBackToRolePage = () => {
      window.location.href = `index.html?section=${from}`;
    };
    returnButton.addEventListener("click", goBackToRolePage);

    const dialogueOption = {
      text: "",
    }
    //Dialogue
    const allOptions = [];
    

    
    const option_1 = Object.create(dialogueOption); //prwto dialogue option
    option_1.text = "Καλως ήρθατε στην προετοιμασία του Ρωμαίου πολεμιστή";
    allOptions.push(option_1);
    
    const option_2 = Object.create(dialogueOption); //deftero dialogue option
    option_2.text = "Ένας νέος Ρωμαίος πολεμιστής περιηγείται στον στρατόπεδο στην προσπάθεια του να συλλέξει τον απαραίτητο εξοπλισμό για την επόμενη μεγάλη εκστρατεία.";
    allOptions.push(option_2);

    const option_3 = Object.create(dialogueOption); //...
    option_3.text = "Πολεμιστής: Και τωρα τι? Πρέπει να βρω μόνος μου το μέρος που θα παραλάβω τον εξοπλισμό μου? Σε τόσο μεγάλο στρατόπεδο? Δυστάζω να ζητήσω στην βοήθεια των παλιών. Νιώθω σαν τη μύγα μέσα στο γάλα εδώ πέρα.";
    allOptions.push(option_3);
    
    const option_4 = Object.create(dialogueOption);
    option_4.text = "Ψυχή: Θυμήσου στρατιώτη... Εδώ ο καθένας χτίζει το κύρος του με το μυαλό του και τη δύναμη της ψυχής του. Κανένας δεν θα σταθεί για σένα αν πρώτα εσύ ο ίδιος δεν μπορέσεις να προσαρμοστείς στις συνθήκες εδώ μέσα.";
    allOptions.push(option_4);
	
	const option_5 = Object.create(dialogueOption); 
    option_5.text = "Πολεμιστής: Σωστά! Όμως έχω ακούσει ότι για κάθε μέρος του εξοπλισμού οι στρατιώτες είναι υποχρεωμένοι καταθέτουν χρήματα για το ταμείο του στρατοπέδου. Εγώ δεν έχω ούτε δεκάρα!";
    allOptions.push(option_5);
	
    const option_6 = Object.create(dialogueOption); 
    option_6.text = "Ψυχή: Στρατιώτη... Πρέπει να βρεις μόνος σου τον τρόπο να συλλέξεις ρωμαικά νομίσματα. Σίγουρα θα υπάρχουν μερικά διάσπαρτα στο στρατόπεδο που έχουν πέσει κατά λάθος από άλλους στρατιώτες.";
    allOptions.push(option_6);
	
	const option_7 = Object.create(dialogueOption); 
    option_7.text = "Πολεμιστής: Δηλαδή θα κάτσω εγώ να ψάχνω σε ολόκληρο στρατόπεδο για μερικά νομίσματα? Δεν έιμαι κανένας ζητιάνος! Ούτε θέλω οι υπόλοιποι να με περάσουν για ηλίθιο. Θέλω να διατηρήσω μια αξιοπρέπεια και να κερδίσω τον σεβασμό όλων. ";
    allOptions.push(option_7);
	
	const option_8 = Object.create(dialogueOption); 
    option_8.text = "Ψυχή: Στρατιώτη... Για να κερδίσεις τον σεβασμό εδώ μέσα πρέπει πρώτα να προσαρμοστείς στις συνθήκες και έπειτα να δείξεις την δυναμή σου. Οπότε βρες νομίσματα γρήγορα γιατί μέχρι αύριο θα πρέπει να έχεις εξοπλιστεί και να παρουσιαστής στον άρχοντα. ";
    allOptions.push(option_8);
	
	const option_9 = Object.create(dialogueOption); 
    option_9.text = "Έχεις δίκιο πρέπει να βιαστώ!";
    allOptions.push(option_9);
	
    const option_10 = Object.create(dialogueOption); //prwto dialogue option
    option_10.text = "Πατήστε Play για να ξεκινήσετε την προετοιμασία. Πατήστε Quit για να αποχωρήσετε όποτε θέλετε.";
    allOptions.push(option_10);
	
    const currentOption = Object.create(dialogueOption);
    currentOption.text = allOptions[0].text;
    let currentOptionIndex = 0;
    
    
    const dialogueBox = document.querySelector("#dialogue");
    dialogueBox.querySelector("p").textContent = currentOption.text;
    const nextDialogueButton = document.querySelector("#dialogue-button");

    function SetDialogueOption(){
      currentOptionIndex ++;
      currentOption.text = allOptions[currentOptionIndex].text;

      dialogueBox.querySelector("p").textContent = currentOption.text;

      console.log("called", currentOptionIndex);
    }


    // Function to create the AR experience (gltf model, mp3 sound)
    const createExperience = async (modelPath, anchorIndex, listener, audioPath, scaleVector) => {
      const model = await loadGLTF(modelPath);
      model.scene.scale.copy(scaleVector);
      model.scene.position.set(0, 0, 0);

      const anchor = mindarThree.addAnchor(anchorIndex);
      anchor.group.add(model.scene);

      const audioBuffer = await loadAudio(audioPath);

      const audio = new THREE.PositionalAudio(listener);
      audio.setBuffer(audioBuffer);
      audio.setRefDistance(100);
      audio.setLoop(true);
      audio.setVolume(0.5); // volume 0-1

      anchor.group.add(audio);

      anchor.onTargetFound = () => audio.play();
      anchor.onTargetLost = () => audio.pause();

      return anchor;
    };

    const start = async () => {
      if (isStarted) return;
      isStarted = true;
	  dialogueBox.disabled = true;
	  dialogueBox.style.display = 'none';
      nextDialogueButton.disabled = true;
	  nextDialogueButton.style.display = 'none';
	  document.body.style.backgroundImage="none";
      mindarThree = new window.MINDAR.IMAGE.MindARThree({
        container: arUI,
        imageTargetSrc: './assets/targets/final.mind' // Βεβαιώσου ότι περιέχει 3 στόχους
      });

      const { renderer, scene, camera } = mindarThree;

      const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
      scene.add(light);

      const listener = new THREE.AudioListener();
      camera.add(listener);

      
      

      // Create 3 AR experiences
      await createExperience(
        './assets/models/coin/scene.gltf', 
        0, 
        listener, 
        './assets/sounds/coinsound1.wav', 
        new THREE.Vector3(0.2, 0.2, 0.2) 
      );

      await createExperience(
        './assets/models/helmet/scene.gltf', 
        1, 
        listener, 
        './assets/sounds/helmetsound.wav', 
        new THREE.Vector3(0.2, 0.2, 0.2) 
      );

      await createExperience(
        './assets/models/spear/scene.gltf', 
        2, 
        listener, 
        './assets/sounds/spearsound.wav', 
        new THREE.Vector3(1.3, 1.3, 1.3)
      );
	  
	  await createExperience(
        './assets/models/coin/scene.gltf', 
        3, 
        listener, 
        './assets/sounds/coinsound2.wav', 
        new THREE.Vector3(0.2, 0.2, 0.2) 
      );
	  
	  await createExperience(
        './assets/models/armor/scene.gltf', 
        4, 
        listener, 
        './assets/sounds/armorsound.wav', 
        new THREE.Vector3(0.2, 0.2, 0.2) 
      );
	  
	  await createExperience(
        './assets/models/coin/scene.gltf', 
        5, 
        listener, 
        './assets/sounds/coinsound3.wav', 
        new THREE.Vector3(0.2, 0.2, 0.2) 
      );
	  
	  await createExperience(
        './assets/models/shield/scene.gltf', 
        6, 
        listener, 
        './assets/sounds/shieldsound.wav', 
        new THREE.Vector3(0.2, 0.2, 0.2) 
      );

      await mindarThree.start();

      renderer.setAnimationLoop(() => {
        renderer.render(scene, camera);
      });

      startAREngineButton.disabled = true;
    };


    startAREngineButton.addEventListener("click", start);
    nextDialogueButton.addEventListener("click", SetDialogueOption);
	
	
  </script>
  

</body>
</html>
